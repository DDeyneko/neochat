<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeoChat V9.0 Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%);
            --sidebar-bg: rgba(0, 0, 0, 0.2);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --primary: #ff4b6e;
            --msg-me: linear-gradient(135deg, #ff4b6e 0%, #ff758c 100%);
            --text: #ffffff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-grad); color: var(--text); height: 100vh; overflow: hidden; }

        /* AUTH */
        #auth-screen { position: fixed; inset: 0; z-index: 999; display: flex; align-items: center; justify-content: center; background: var(--bg-grad); }
        .auth-card { background: rgba(0,0,0,0.4); backdrop-filter: blur(20px); padding: 40px; border-radius: 24px; border: var(--glass-border); width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .auth-input { width: 100%; padding: 14px; margin: 10px 0; background: rgba(255,255,255,0.05); border: var(--glass-border); border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .auth-btn { width: 100%; padding: 14px; margin-top: 10px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .auth-btn:hover { transform: scale(1.02); opacity: 0.9; }
        .auth-toggle { margin-top: 15px; font-size: 0.9rem; color: #ccc; cursor: pointer; }

        /* DRAG & DROP */
        #drop-zone { position: fixed; inset: 0; background: rgba(255, 75, 110, 0.2); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; border: 4px dashed var(--primary); color: white; font-size: 2rem; font-weight: bold; pointer-events: none; }

        /* APP LAYOUT */
        #app { display: none; width: 100%; height: 100%; }
        
        /* SIDEBAR */
        aside { width: 300px; background: var(--sidebar-bg); backdrop-filter: blur(10px); border-right: var(--glass-border); display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 100; }
        .sb-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; letter-spacing: 1px; color: var(--primary); }
        .icon-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.7; transition: 0.2s; margin-left: 10px;}
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }
        .sb-tabs { display: flex; padding: 10px; gap: 5px; }
        .sb-tab { flex: 1; padding: 8px; border-radius: 8px; background: transparent; color: #aaa; border: none; cursor: pointer; transition: 0.3s; }
        .sb-tab.active { background: rgba(255,255,255,0.1); color: white; }
        .sb-list { flex: 1; overflow-y: auto; padding: 10px; }
        .list-item { display: flex; align-items: center; padding: 12px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.active { background: linear-gradient(90deg, rgba(255,255,255,0.1), transparent); border-left: 3px solid var(--primary); }
        .avatar { width: 42px; height: 42px; border-radius: 12px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; font-size: 1.1rem; flex-shrink: 0; background-size: cover; background-position: center; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; margin-left: auto; }
        .status-dot.online { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .add-btn { margin: 15px; padding: 12px; background: rgba(255,255,255,0.05); border: var(--glass-border); border-radius: 12px; color: white; cursor: pointer; }
        .add-btn:hover { background: rgba(255,255,255,0.1); }

        /* MAIN CHAT */
        main { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.1); position: relative; }
        .chat-header { height: 70px; padding: 0 20px; display: flex; align-items: center; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-bottom: var(--glass-border); justify-content: space-between; }
        .menu-toggle { display: none; margin-right: 15px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .chat-info h2 { font-size: 1.1rem; margin-bottom: 2px; }
        .chat-info span { font-size: 0.8rem; opacity: 0.6; }

        #search-box { display:none; padding: 10px 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); }
        #search-input { width: 100%; padding: 8px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: white; }

        #pinned-bar { background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 8px 20px; font-size: 0.85rem; display: none; cursor: pointer; border-left: 3px solid var(--primary); }
        #pinned-bar strong { color: var(--primary); margin-right: 5px; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; position: relative; }
        
        /* TYPING INDICATOR */
        #typing-indicator { position: absolute; bottom: 90px; left: 25px; font-size: 0.8rem; opacity: 0.8; color: var(--primary); font-style: italic; display: none; z-index: 20; pointer-events: none; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 10px; }
        .dot { animation: jump 1.2s infinite; display: inline-block; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* MESSAGES */
        .msg { display: flex; flex-direction: column; max-width: 75%; }
        .msg.in { align-self: flex-start; }
        .msg.out { align-self: flex-end; align-items: flex-end; }
        .msg-row { display: flex; gap: 10px; align-items: flex-end; }
        .msg.out .msg-row { flex-direction: row-reverse; }
        .msg-avatar { width: 30px; height: 30px; border-radius: 10px; background: rgba(255,255,255,0.1); flex-shrink: 0; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
        
        .bubble { padding: 12px 18px; border-radius: 18px; position: relative; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .msg.in .bubble { background: rgba(255,255,255,0.1); color: white; border-bottom-left-radius: 4px; }
        .msg.out .bubble { background: var(--msg-me); color: white; border-bottom-right-radius: 4px; }
        
        .msg-sender { font-size: 0.75rem; margin-bottom: 4px; opacity: 0.7; margin-left: 5px; color: var(--primary); }
        .msg.out .msg-sender { display: none; }
        
        .edited-mark { font-size: 0.7em; opacity: 0.6; margin-left: 5px; font-style: italic; }
        .mention { background: rgba(255, 75, 110, 0.3); padding: 0 4px; border-radius: 4px; color: white; font-weight: bold; }
        
        .msg-meta { text-align: right; font-size: 0.6rem; opacity: 0.6; margin-top: 4px; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
        .tick { font-size: 0.8rem; }
        .tick.read { color: #4deeea; text-shadow: 0 0 5px #4deeea; }

        .file-bubble { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; text-decoration: none; color: white; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .file-bubble:hover { background: rgba(255,255,255,0.1); }
        .file-icon { font-size: 1.5rem; }
        .file-name { font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* POLLS */
        .poll-card { min-width: 250px; }
        .poll-title { font-weight: bold; margin-bottom: 10px; display: block; font-size: 1rem; }
        .poll-opt { margin-bottom: 8px; cursor: pointer; position: relative; }
        .poll-bar-bg { height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden; position: relative; }
        .poll-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease-out; opacity: 0.7; }
        .poll-text { position: absolute; left: 10px; top: 3px; font-size: 0.85rem; z-index: 2; display: flex; justify-content: space-between; width: 90%; }

        .reactions { display: flex; gap: 4px; margin-top: -10px; z-index: 2; padding: 0 5px; margin-left: 40px; }
        .msg.out .reactions { justify-content: flex-end; margin-left: 0; margin-right: 40px; }
        .react-pill { background: rgba(30,30,30,0.9); border: 1px solid #555; border-radius: 10px; padding: 2px 6px; font-size: 0.75rem; cursor: pointer; }
        .react-pill.active { border-color: var(--primary); color: var(--primary); }

        .media-img { max-width: 100%; border-radius: 12px; cursor: zoom-in; margin-top: 5px; max-height: 300px; object-fit: cover; }
        .audio-player { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 24px; margin-top: 5px; min-width: 200px; }
        .play-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: white; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; padding-left: 3px; }
        .play-btn.playing { padding-left: 0; background: var(--primary); color: white; }
        .wave-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; overflow: hidden; cursor: pointer; }
        .wave-prog { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0.7); transform: scale(1); } 70% { box-shadow: 0 0 0 15px rgba(255, 75, 110, 0); transform: scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0); transform: scale(1); } }
        .rec-pulse { animation: pulse-red 1.5s infinite; background: #ff4b6e !important; color: white !important; }

        /* CALL UI */
        #call-overlay { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; background: #333; margin-bottom: 20px; border: 3px solid var(--primary); background-size: cover; background-position: center; box-shadow: 0 0 30px var(--primary); animation: pulse-call 2s infinite; }
        .call-status { font-size: 1.2rem; opacity: 0.7; margin-bottom: 40px; }
        .call-controls { display: flex; gap: 30px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; color: white; transition: 0.3s; }
        .call-btn.accept { background: #00ff88; box-shadow: 0 0 20px #00ff88; }
        .call-btn.reject { background: #ff4b6e; box-shadow: 0 0 20px #ff4b6e; }
        .call-btn:hover { transform: scale(1.1); }
        @keyframes pulse-call { 0% {box-shadow: 0 0 0 0 rgba(255, 75, 110, 0.4);} 70% {box-shadow: 0 0 0 30px rgba(255, 75, 110, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 75, 110, 0);} }

        /* EMOJI PICKER */
        #emoji-picker { position: absolute; bottom: 80px; right: 20px; background: rgba(30,30,30,0.95); border: 1px solid #555; padding: 10px; border-radius: 12px; display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; width: 250px; height: 200px; overflow-y: auto; z-index: 50; }
        .ep-item { font-size: 1.5rem; cursor: pointer; padding: 5px; text-align: center; border-radius: 5px; }
        .ep-item:hover { background: rgba(255,255,255,0.1); }

        .input-bar { padding: 20px; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-top: var(--glass-border); display: flex; gap: 10px; align-items: center; position: relative; }
        #reply-preview { position: absolute; bottom: 100%; left: 0; width: 100%; background: rgba(20,20,20,0.9); padding: 10px 20px; border-top: 1px solid #333; display: none; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .inp-field { flex: 1; background: rgba(255,255,255,0.05); border: var(--glass-border); padding: 14px; border-radius: 24px; color: white; outline: none; }
        .inp-btn { width: 46px; height: 46px; border-radius: 50%; border: none; background: transparent; color: #aaa; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .inp-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .btn-send { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary); }
        
        .prof-upload { width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.1); margin: 0 auto 15px; border: 2px dashed #555; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center; position: relative; overflow: hidden; }

        dialog { background: #1e1e2e; color: white; border: 1px solid #444; border-radius: 16px; padding: 20px; width: 90%; max-width: 350px; margin: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .d-btn { width: 100%; padding: 12px; background: var(--primary) !important; color: white !important; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer; font-weight: 600; }
        .d-label { display: block; margin-top: 15px; font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; }
        .color-picker { width: 100%; height: 40px; border: none; cursor: pointer; background: none; }

        .poll-input { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 8px; }

        #ctx-menu { position: absolute; background: rgba(30,30,30,0.95); border: 1px solid #444; border-radius: 12px; display: none; z-index: 1000; min-width: 160px; overflow: hidden; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; }
        .ctx-item:hover { background: var(--primary); }
        .ctx-emojis { display: flex; gap: 5px; padding: 8px; justify-content: center; background: rgba(0,0,0,0.3); }
        .ctx-e { font-size: 1.2rem; cursor: pointer; padding: 4px; }
        .ctx-e:hover { transform: scale(1.3); }
        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #lb-img { max-width: 90vw; max-height: 85vh; transition: transform 0.2s; cursor: grab; }

        @media(max-width: 700px) {
            aside { position: absolute; height: 100%; transform: translateX(-100%); width: 85%; background: #1a1c2c; border-right: 1px solid #333; }
            aside.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            .menu-toggle { display: block; }
            .msg { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div id="drop-zone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>

    <div id="call-overlay">
        <div id="call-avatar" class="call-avatar"></div>
        <h2 id="call-name">User</h2>
        <div id="call-status" class="call-status">–ó–≤–æ–Ω–æ–∫...</div>
        <div class="call-controls" id="call-incoming-ctrl" style="display:none;">
            <button class="call-btn reject" onclick="rejectCall()">‚úï</button>
            <button class="call-btn accept" onclick="acceptCall()">üìû</button>
        </div>
        <div class="call-controls" id="call-active-ctrl" style="display:none;">
            <button class="call-btn reject" onclick="endCall()">‚úï</button>
        </div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h1>NeoChat v9.0</h1>
            <p style="opacity:0.7; margin-bottom:20px;">Voice Calls & Realtime Polls</p>
            <div id="login-form">
                <input type="text" id="l-user" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
                <input type="password" id="l-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="auth-btn" onclick="auth('login')">–í–æ–π—Ç–∏</button>
                <div class="auth-toggle" onclick="toggleAuth()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            <div id="reg-form" style="display:none;">
                <input type="text" id="r-user" class="auth-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                <input type="password" id="r-pass" class="auth-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button class="auth-btn" style="background:transparent; border:1px solid var(--primary);" onclick="auth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <div class="auth-toggle" onclick="toggleAuth()">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í—Ö–æ–¥</div>
            </div>
        </div>
    </div>

    <div id="app">
        <aside id="sidebar">
            <div class="sb-header"><span>NEOCHAT</span><button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button></div>
            <div class="sb-tabs">
                <button class="sb-tab active" onclick="tab('pm')">–õ–∏—á–Ω—ã–µ</button>
                <button class="sb-tab" onclick="tab('rooms')">–ì—Ä—É–ø–ø—ã</button>
            </div>
            <div id="list-cont" class="sb-list"></div>
            <button id="add-room-btn" class="add-btn" style="display:none;" onclick="document.getElementById('room-modal').showModal()">+ –°–æ–∑–¥–∞—Ç—å</button>
        </aside>
        <main>
            <div class="chat-header">
                <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <div class="chat-info"><h2 id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h2><span id="chat-status">...</span></div>
                <div>
                    <button class="icon-btn" id="call-btn" onclick="startCallCheck()" style="display:none;">üìû</button>
                    <button class="icon-btn" onclick="toggleSearch()">üîç</button>
                </div>
            </div>
            <div id="search-box" style="display:none; padding:10px; background:rgba(0,0,0,0.2);"><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫..." style="width:100%; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.1); color:white;" oninput="doSearch(this.value)"></div>
            <div id="pinned-bar" onclick="scrollToPinned()"><strong>üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ:</strong> <span id="pinned-text">...</span></div>
            
            <div id="messages"></div>
            <div id="typing-indicator"></div>
            
            <div id="emoji-picker"></div>

            <div class="input-bar" id="input-bar" style="display:none;">
                <div id="reply-preview">
                    <span id="rp-text">–û—Ç–≤–µ—Ç...</span>
                    <button onclick="cancelReply()" style="background:none; border:none; color:white;">‚úï</button>
                </div>
                <button class="inp-btn" onclick="document.getElementById('file-in').click()">üìé</button>
                <input type="file" id="file-in" hidden>
                <button class="inp-btn" onclick="toggleEmoji()">üòÄ</button>
                <button class="inp-btn" onclick="openPollModal()">üìä</button>
                <input type="text" class="inp-field" id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" oninput="sendTyping()">
                <button class="inp-btn" id="rec-btn">üéôÔ∏è</button>
                <button class="inp-btn btn-send" onclick="send()">‚û§</button>
            </div>
        </main>
    </div>

    <dialog id="poll-modal">
        <h3>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</h3>
        <input type="text" id="poll-q" class="auth-input" placeholder="–í–æ–ø—Ä–æ—Å">
        <div id="poll-opts">
            <input type="text" class="poll-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
            <input type="text" class="poll-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
        </div>
        <button class="d-btn" style="background:#333 !important; margin-bottom:10px;" onclick="addPollOpt()">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
        <button class="d-btn" onclick="createPoll()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="d-btn" style="background:transparent !important; border:1px solid #555 !important;" onclick="document.getElementById('poll-modal').close()">–û—Ç–º–µ–Ω–∞</button>
    </dialog>

    <dialog id="settings-modal">
        <div style="text-align:center;">
            <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
            <div id="my-avatar-preview" class="prof-upload" onclick="document.getElementById('avatar-in').click()"></div>
            <input type="file" id="avatar-in" hidden accept="image/*">
            <input type="text" id="my-bio" class="auth-input" placeholder="–°—Ç–∞—Ç—É—Å (Bio)">
            <button class="d-btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
        <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
        <h3>–¢–µ–º–∞</h3>
        <span class="d-label">–ê–∫—Ü–µ–Ω—Ç</span><input type="color" class="color-picker" id="cp-primary" value="#ff4b6e" oninput="updateTheme()">
        <span class="d-label">–§–æ–Ω (—Å—Ç–∞—Ä—Ç)</span><input type="color" class="color-picker" id="cp-bg1" value="#1a1c2c" oninput="updateTheme()">
        <span class="d-label">–§–æ–Ω (–∫–æ–Ω–µ—Ü)</span><input type="color" class="color-picker" id="cp-bg2" value="#4a192c" oninput="updateTheme()">
        <button class="d-btn" style="background:#444 !important;" onclick="logout()">–í—ã–π—Ç–∏</button>
        <button class="d-btn" style="background:transparent !important; border:1px solid #555 !important;" onclick="document.getElementById('settings-modal').close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </dialog>

    <dialog id="room-modal">
        <h3>–°–æ–∑–¥–∞—Ç—å</h3>
        <input type="text" id="new-room-name" class="auth-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <select id="new-room-type" class="auth-input" style="background:#111;"><option value="group">–ì—Ä—É–ø–ø–∞</option><option value="channel">–ö–∞–Ω–∞–ª</option></select>
        <button class="d-btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="d-btn" style="background:transparent !important; margin-top:5px;" onclick="document.getElementById('room-modal').close()">–û—Ç–º–µ–Ω–∞</button>
    </dialog>

    <div id="ctx-menu">
        <div class="ctx-emojis">
            <span class="ctx-e" onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="ctx-e" onclick="react('üòÇ')">üòÇ</span>
            <span class="ctx-e" onclick="react('üëç')">üëç</span><span class="ctx-e" onclick="react('üî•')">üî•</span>
        </div>
        <div class="ctx-item" onclick="doReply()">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="ctx-item" onclick="startEdit()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</div>
        <div class="ctx-item" onclick="pinMsg()">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
        <div class="ctx-item" onclick="deleteMsg()" style="color:#ff4b6e;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>
        <div class="ctx-item" onclick="kickUser()" id="ctx-kick" style="display:none;">ü¶∂ –ò—Å–∫–ª—é—á–∏—Ç—å</div>
        <div class="ctx-item" onclick="banUser()" id="ctx-ban" style="display:none;">üö´ –ó–∞–±–∞–Ω–∏—Ç—å</div>
        <div class="ctx-item" onclick="doCopy()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
    </div>

    <div id="lightbox" onwheel="zoomImage(event)">
        <img id="lb-img"><button class="d-btn" style="width:auto; position:absolute; bottom:30px;" onclick="document.getElementById('lightbox').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ---
        const SERVER_URL = "neochat-server-khix.onrender.com"; 

        let ws, myNick, myAvatar, myBio;
        let currentTab='pm', context=null, target=null, replyTo=null;
        let ctxMsgId, ctxText, ctxSender, editingId=null;
        let contacts=[], rooms=[], roomMeta=null, pinnedMsgId=null;
        let mediaRecorder, audioChunks=[], zoomLevel=1, currentAudio=null;
        let typingTimer=null;

        // --- WebRTC VARIABLES ---
        let localStream;
        let peerConnection;
        const rtcConfig = { 
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" },
                { urls: "stun:stun3.l.google.com:19302" },
                { urls: "stun:stun4.l.google.com:19302" },
                { urls: "stun:global.stun.twilio.com:3478" }
            ] 
        };
        let inCall = false;
        let callTarget = null;

        // --- EMOJI INIT ---
        const emojis = ["üòÄ","üòÇ","üòç","üòé","üò≠","üò°","üëç","üëé","üî•","‚ù§Ô∏è","üéâ","üí©","ü§î","üò±","üëã","üôè","üëª","üíÄ","üëÄ","üí™"];
        const ep = document.getElementById('emoji-picker');
        emojis.forEach(e => { const s=document.createElement('div'); s.className='ep-item'; s.innerText=e; s.onclick=()=>{ document.getElementById('msg-in').value+=e; ep.style.display='none'; }; ep.appendChild(s); });

        function toggleAuth() { const l=document.getElementById('login-form'), r=document.getElementById('reg-form'); l.style.display=l.style.display==='none'?'block':'none'; r.style.display=r.style.display==='none'?'block':'none'; }
        function $(id) { return document.getElementById(id); }
        
        function auth(a) {
            const u=$('l-user').value.trim() || $('r-user').value.trim();
            const p=$('l-pass').value.trim() || $('r-pass').value.trim();
            if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
            
            // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö RENDER (Secure WSS)
            ws = new WebSocket(`wss://${SERVER_URL}`);
            
            ws.onopen = () => ws.send(JSON.stringify({type: 'auth_req', action: a, username: u, password: p}));
            ws.onmessage = (e) => {
                const d=JSON.parse(e.data);
                if(d.type==='auth_success') { 
                    myNick=d.nick; myAvatar=d.avatar; myBio=d.bio; 
                    $('auth-screen').style.display='none'; $('app').style.display='flex'; 
                    initApp(); loadTheme(); Notification.requestPermission();
                }
                else if(d.type==='auth_error') { alert(d.text); ws.close(); }
            };
        }
        function logout() { location.reload(); }

        function initApp() {
            ws.onmessage = (e) => handleMsg(JSON.parse(e.data));
            ws.onclose = () => alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ");
            document.addEventListener('dragover', e => { e.preventDefault(); $('drop-zone').style.display='flex'; });
            document.addEventListener('dragleave', e => { if(e.clientX===0 && e.clientY===0) $('drop-zone').style.display='none'; });
            document.addEventListener('drop', e => { e.preventDefault(); $('drop-zone').style.display='none'; handleFiles(e.dataTransfer.files); });
        }

        function handleMsg(d) {
            if(d.type==='contacts_list') { contacts=d.users; if(currentTab==='pm') renderList(); }
            else if(d.type==='rooms_list') { rooms=d.rooms; if(currentTab==='rooms') renderList(); }
            else if(d.type==='history') {
                $('messages').innerHTML=''; roomMeta=d.room_info; updateInputState();
                if(d.pinned) showPinned(d.pinned); else $('pinned-bar').style.display='none';
                d.history.forEach(renderMessage); scrollToBottom();
            }
            else if(['msg','image','video','audio','file','poll'].includes(d.type)) {
                let render = false;
                if(context==='pm' && (d.sender===target || (d.sender===myNick && d.recipient===target))) render=true;
                if(context==='room' && d.room_name===target) render=true;
                if(render) { renderMessage(d); scrollToBottom(); }
                
                if(document.hidden && d.sender!==myNick) {
                     new Notification(`NeoChat: ${d.sender}`, {body: d.text || "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", icon: d.sender_avatar});
                }
                if(context==='pm' && d.sender===target && d.recipient===myNick) { ws.send(JSON.stringify({type:'mark_read', sender: target})); }
            }
            else if(d.type==='typing') {
                if((context==='room' && d.room_name===target) || (context==='pm' && d.nick===target)) {
                    const ind = $('typing-indicator');
                    ind.innerHTML = `${d.nick} –ø–µ—á–∞—Ç–∞–µ—Ç <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>`;
                    ind.style.display='block';
                    clearTimeout(window.typingClear);
                    window.typingClear = setTimeout(() => ind.style.display='none', 3000);
                }
            }
            else if(d.type==='pinned_update') { if(context==='room' && d.room_name===target) showPinned(d.msg); }
            else if(d.type==='reaction_update') updateReactions(d.id, d.reactions);
            else if(d.type==='poll_update') updatePollUI(d.id, d.results);
            else if(d.type==='msg_edited') {
                const el=$(`msg-${d.id}`);
                if(el) { 
                    const b=el.querySelector('.bubble span'); 
                    if(b) b.innerHTML=parseMarkdown(d.text); 
                    if(!el.querySelector('.edited-mark')) b.insertAdjacentHTML('afterend','<span class="edited-mark">(—Ä–µ–¥.)</span>'); 
                }
            }
            else if(d.type==='msg_deleted') { const el=$(`msg-${d.id}`); if(el) el.remove(); }
            else if(d.type==='msgs_read_by_user') {
                if(context==='pm' && target===d.reader) {
                    document.querySelectorAll('.msg.out .tick').forEach(t => t.classList.add('read'));
                }
            }
            // --- WebRTC SIGNALS ---
            else if(d.type==='signal') handleSignal(d);

            else if(d.type==='info') alert(d.text);
            else if(d.type==='error') alert(d.text);
        }

        // --- MARKDOWN PARSER ---
        function parseMarkdown(text) {
            if(!text) return "";
            let html = text;
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/__(.*?)__/g, '<i>$1</i>');
            html = html.replace(/~~(.*?)~~/g, '<s>$1</s>');
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            html = html.replace(new RegExp(`@${myNick}`, 'g'), `<span class="mention">@${myNick}</span>`);
            return html;
        }

        function renderMessage(msg) {
            const isMe = msg.sender===myNick;
            const div = document.createElement('div');
            div.className = `msg ${isMe?'out':'in'}`; div.id = `msg-${msg.id}`;
            div.oncontextmenu = (e) => openCtx(e, msg.id, msg.text||'', msg.sender);

            let content = "";
            if(msg.replyTo) content += `<div style="font-size:0.8rem; opacity:0.7; border-left:2px solid white; padding-left:5px; margin-bottom:5px;">–û—Ç–≤–µ—Ç: ${msg.replyTo.text.substring(0,20)}...</div>`;
            
            if(msg.type==='poll') {
                const options = JSON.parse(msg.data);
                content += `<div class="poll-card" id="poll-${msg.id}"><span class="poll-title">${msg.text}</span>`;
                options.forEach((opt, idx) => {
                    content += `
                        <div class="poll-opt" onclick="vote(${msg.id}, ${idx})">
                            <div class="poll-bar-bg"><div class="poll-bar-fill" id="pf-${msg.id}-${idx}" style="width:0%"></div></div>
                            <div class="poll-text"><span id="pt-${msg.id}-${idx}-t">${opt}</span><span id="pt-${msg.id}-${idx}-p">0%</span></div>
                        </div>`;
                });
                content += `</div>`;
                // Defer poll update
                setTimeout(()=>updatePollUI(msg.id, msg.poll_results || {}), 0);
            }
            else if(msg.type==='image') content += `<img src="data:image/jpeg;base64,${msg.data}" class="media-img" onclick="viewImg(this.src)">`;
            else if(msg.type==='audio') content += `<div class="audio-player"><button class="play-btn" onclick="playAudio(this, '${msg.data}')">‚ñ∂</button><div class="wave-bar"><div class="wave-prog"></div></div></div>`;
            else if(msg.type==='file') content += `<a href="data:application/octet-stream;base64,${msg.data}" download="${msg.filename}" class="file-bubble"><span class="file-icon">üìÑ</span><span class="file-name">${msg.filename}</span></a>`;
            else {
                content += `<span>${parseMarkdown(msg.text)}</span>${msg.is_edited?'<span class="edited-mark">(—Ä–µ–¥.)</span>':''}`;
            }

            let reactsHtml = `<div class="reactions" id="reacts-${msg.id}">`;
            if(msg.reactions) for(let [e,s] of Object.entries(msg.reactions)) reactsHtml+=`<div class="react-pill ${s.includes(myNick)?'active':''}" onclick="sendReact(${msg.id}, '${e}')">${e} ${s.length}</div>`;
            reactsHtml += `</div>`;

            const ts = msg.timestamp ? msg.timestamp*1000 : Date.now();
            const time = new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            let ticks = "";
            if(isMe && context === 'pm') ticks = `<span class="tick ${msg.is_read?'read':''}">${msg.is_read ? '‚úì‚úì' : '‚úì'}</span>`;

            const avStyle = msg.sender_avatar ? `background-image:url(${msg.sender_avatar})` : `background:linear-gradient(45deg,#555,#777)`;
            const avHtml = `<div class="msg-avatar" style="${avStyle}">${msg.sender_avatar?'':msg.sender.substring(0,2).toUpperCase()}</div>`;

            div.innerHTML = `
                <div class="msg-row">
                    ${!isMe ? avHtml : ''}
                    <div>
                        <div class="msg-sender">${msg.sender}</div>
                        <div class="bubble">${content}<div class="msg-meta">${time} ${ticks}</div></div>
                    </div>
                </div>
                ${reactsHtml}
            `;
            $('messages').appendChild(div);
        }
        
        // --- POLL LOGIC (FIXED) ---
        function openPollModal() { document.getElementById('poll-modal').showModal(); }
        function addPollOpt() { const i=document.createElement('input'); i.type='text'; i.className='poll-input'; i.placeholder=`–í–∞—Ä–∏–∞–Ω—Ç ${document.querySelectorAll('.poll-input').length+1}`; document.getElementById('poll-opts').appendChild(i); }
        function createPoll() {
            const q = $('poll-q').value.trim();
            const opts = Array.from(document.querySelectorAll('.poll-input')).map(i=>i.value.trim()).filter(v=>v);
            if(!q || opts.length<2) return alert("–ù—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å –∏ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞");
            const payload = { type: 'poll', text: q, options: opts, ...(context==='pm'?{recipient:target}:{room_name:target}) };
            ws.send(JSON.stringify(payload));
            document.getElementById('poll-modal').close();
            $('poll-q').value = ''; $('poll-opts').innerHTML = '<input type="text" class="poll-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1"><input type="text" class="poll-input" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">';
        }
        function vote(mid, idx) { ws.send(JSON.stringify({type: 'vote_poll', message_id: mid, option_index: idx, ...(context==='room'?{room_name:target}:{})})); }
        
        function updatePollUI(mid, results) {
            const p = $(`poll-${mid}`);
            if(!p) return;
            let total = 0;
            Object.values(results).forEach(arr => total += arr.length);
            
            const bars = p.querySelectorAll('.poll-bar-fill');
            bars.forEach((bar, i) => {
                const count = results[i] ? results[i].length : 0;
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                const fill = $(`pf-${mid}-${i}`);
                const txt = $(`pt-${mid}-${i}-p`);
                if(fill) fill.style.width = `${pct}%`;
                if(txt) txt.innerText = `${pct}% (${count})`;
            });
        }

        // --- VOICE CALLS (WebRTC) ---
        function startCallCheck() {
            if(context === 'room') {
                if(confirm("–ù–∞—á–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫? –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã —É–≤–∏–¥—è—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ.")) startCall();
            } else {
                startCall();
            }
        }

        async function startCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                createPeerConnection();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                sendSignal({ type: 'offer', sdp: offer });
                
                showCallUI('outgoing', target);
                inCall = true;
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + e);
            }
        }

        async function handleSignal(d) {
            if (d.data.type === 'offer') {
                // Incoming call
                if(inCall) return; // Busy
                callTarget = d.sender; // Set who is calling
                const displayName = d.room_name ? `${d.sender} (–≤ ${d.room_name})` : d.sender;
                showCallUI('incoming', displayName, d.sender_avatar);
                
                window.pendingOffer = d.data.sdp;
                window.pendingSender = d.sender; 
            } 
            else if (d.data.type === 'answer') {
                if(!inCall) return;
                await peerConnection.setRemoteDescription(new RTCSessionDescription(d.data.sdp));
                $('call-status').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–æ";
            } 
            else if (d.data.type === 'candidate') {
                if(inCall && peerConnection) {
                    try { await peerConnection.addIceCandidate(new RTCIceCandidate(d.data.candidate)); } catch(e){}
                }
            }
            else if (d.data.type === 'bye') {
                closeCallUI();
            }
        }

        async function acceptCall() {
            $('call-incoming-ctrl').style.display='none';
            $('call-active-ctrl').style.display='flex';
            $('call-status').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                createPeerConnection();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                ws.send(JSON.stringify({
                    type: 'signal',
                    target: window.pendingSender, 
                    data: { type: 'answer', sdp: answer }
                }));
                
                inCall = true;
                callTarget = window.pendingSender;
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞: " + e);
                closeCallUI();
            }
        }

        function rejectCall() {
            ws.send(JSON.stringify({ type: 'signal', target: window.pendingSender, data: { type: 'bye' } }));
            closeCallUI();
        }

        function endCall() {
            if(callTarget) {
                const payload = { type: 'signal', data: { type: 'bye' } };
                if(context==='room') payload.room_name = target; 
                else payload.target = callTarget;
                ws.send(JSON.stringify(payload));
            }
            closeCallUI();
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            peerConnection.onicecandidate = (e) => {
                if (e.candidate) {
                    sendSignal({ type: 'candidate', candidate: e.candidate });
                }
            };
            peerConnection.ontrack = (e) => {
                $('remote-audio').srcObject = e.streams[0];
            };
        }

        function sendSignal(data) {
            const payload = { type: 'signal', data: data };
            if(context === 'pm') payload.target = target;
            else payload.room_name = target;
            ws.send(JSON.stringify(payload));
        }

        function showCallUI(state, name, av) {
            const ov = $('call-overlay');
            ov.style.display = 'flex';
            $('call-name').innerText = name;
            $('call-avatar').style.backgroundImage = av ? `url(${av})` : '';
            
            if(state === 'incoming') {
                $('call-status').innerText = "–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...";
                $('call-incoming-ctrl').style.display = 'flex';
                $('call-active-ctrl').style.display = 'none';
            } else {
                $('call-status').innerText = "–ó–≤–æ–Ω–æ–∫...";
                $('call-incoming-ctrl').style.display = 'none';
                $('call-active-ctrl').style.display = 'flex';
            }
        }

        function closeCallUI() {
            $('call-overlay').style.display = 'none';
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(peerConnection) peerConnection.close();
            localStream = null;
            peerConnection = null;
            inCall = false;
            callTarget = null;
        }

        // --- STANDARD LOGIC ---
        function send() {
            const txt = $('msg-in').value.trim(); if(!txt) return;
            if(editingId) { ws.send(JSON.stringify({type:'edit_msg', id:editingId, text:txt, ...(context==='pm'?{recipient:target}:{room_name:target})})); editingId=null; $('reply-preview').style.display='none'; }
            else { ws.send(JSON.stringify({type:'msg', text:txt, replyTo:replyTo, ...(context==='pm'?{recipient:target}:{room_name:target})})); }
            $('msg-in').value=''; cancelReply();
        }
        function toggleEmoji() { const e=$('emoji-picker'); e.style.display = e.style.display==='grid'?'none':'grid'; }
        function sendTyping() {
            if(typingTimer) return;
            typingTimer = setTimeout(() => {
                ws.send(JSON.stringify({type:'typing', nick:myNick, ...(context==='pm'?{recipient:target}:{room_name:target})}));
                typingTimer = null;
            }, 2000);
        }

        /* ... (Helpers) ... */
        function handleFiles(files) {
            const f = files[0]; if(!f) return;
            if(f.size > 20*1024*1024) return alert("–§–∞–π–ª > 20MB");
            const reader = new FileReader();
            reader.onload = () => {
                const b64 = reader.result.split(',')[1];
                let type = 'file';
                if(f.type.startsWith('image')) type='image';
                const payload = { type, data: b64, filename: f.name, replyTo: replyTo, ...(context==='pm'?{recipient:target}:{room_name:target}) };
                ws.send(JSON.stringify(payload));
            };
            reader.readAsDataURL(f);
        }
        $('file-in').onchange = function() { handleFiles(this.files); this.value=''; };
        
        function tab(t) { currentTab=t; document.querySelectorAll('.sb-tab').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); $('add-room-btn').style.display=t==='rooms'?'block':'none'; renderList(); }
        function toggleSidebar() { $('sidebar').classList.toggle('open'); }
        function closeSidebarIfMobile() { $('sidebar').classList.remove('open'); }
        function openSettings() { $('settings-modal').showModal(); $('my-bio').value=myBio||""; if(myAvatar)$('my-avatar-preview').style.backgroundImage=`url(${myAvatar})`; }
        function updateTheme() { const p=$('cp-primary').value, b1=$('cp-bg1').value, b2=$('cp-bg2').value; document.documentElement.style.setProperty('--primary',p); document.documentElement.style.setProperty('--bg-grad',`linear-gradient(135deg, ${b1}, ${b2})`); document.documentElement.style.setProperty('--msg-me',`linear-gradient(135deg, ${p}, ${p}99)`); localStorage.setItem('neoTheme',JSON.stringify({p,b1,b2})); }
        function loadTheme() { const t=JSON.parse(localStorage.getItem('neoTheme')); if(t) { $('cp-primary').value=t.p; $('cp-bg1').value=t.b1; $('cp-bg2').value=t.b2; updateTheme(); } }
        function getAvatarStyle(u,av) { return av?`background-image:url(${av})`:`background:linear-gradient(45deg,#555,#777)`; }
        function renderList() {
            const c=$('list-cont'); c.innerHTML='';
            if(currentTab==='pm') contacts.forEach(u => { c.innerHTML += `<div class="list-item ${context==='pm'&&target===u.nick?'active':''}" onclick="openChat('pm','${u.nick}')"><div class="avatar" style="${getAvatarStyle(u.nick,u.avatar)}">${u.avatar?'':u.nick[0].toUpperCase()}</div><div style="flex:1;"><div>${u.nick}</div><div style="font-size:0.8rem;opacity:0.5;">${u.bio||(u.online?'–í —Å–µ—Ç–∏':'–û—Ñ–ª–∞–π–Ω')}</div></div><div class="status-dot ${u.online?'online':''}"></div></div>`; });
            else rooms.forEach(r => { c.innerHTML += `<div class="list-item ${context==='room'&&target===r.name?'active':''}" onclick="openChat('room','${r.name}')"><div class="avatar" style="background:var(--primary)">${r.type==='group'?'#':'üì¢'}</div><div style="flex:1;"><div>${r.name}</div><div style="font-size:0.8rem;opacity:0.5;">${r.type==='group'?'–ì—Ä—É–ø–ø–∞':'–ö–∞–Ω–∞–ª'}</div></div></div>`; });
        }
        function openChat(c,t) { 
            context=c; target=t; 
            $('chat-title').innerText=t; $('chat-status').innerText=c==='pm'?'–õ–∏—á–Ω—ã–π —á–∞—Ç':'–ó–∞–≥—Ä—É–∑–∫–∞...'; 
            $('call-btn').style.display = 'block';
            
            closeSidebarIfMobile(); renderList(); ws.send(JSON.stringify({type:'history_req',context,target})); cancelReply(); 
        }
        function updateInputState() { const b=$('input-bar'); if(context==='room'&&roomMeta&&roomMeta.type==='channel'&&roomMeta.creator!==myNick) b.style.display='none'; else b.style.display='flex'; if(context==='room')$('chat-status').innerText=roomMeta.type==='group'?'–ì—Ä—É–ø–ø–∞':'–ö–∞–Ω–∞–ª'; }
        function saveProfile() { const b=$('my-bio').value, f=$('avatar-in').files[0]; if(f){const r=new FileReader();r.onload=()=>{myAvatar=r.result;myBio=b;ws.send(JSON.stringify({type:'update_profile',avatar:myAvatar,bio:b}));};r.readAsDataURL(f);}else{myBio=b;ws.send(JSON.stringify({type:'update_profile',avatar:myAvatar,bio:b}));} $('settings-modal').close(); }
        function playAudio(b,d) { if(currentAudio){currentAudio.pause();if(currentAudio.uiBtn){currentAudio.uiBtn.innerText='‚ñ∂';currentAudio.uiBtn.classList.remove('playing');}} const s=new Audio(`data:audio/webm;base64,${d}`); currentAudio=s; currentAudio.uiBtn=b; b.innerText='‚ùö‚ùö'; b.classList.add('playing'); const bar=b.nextElementSibling.firstElementChild; s.ontimeupdate=()=>{bar.style.width=(s.currentTime/s.duration)*100+'%';}; s.onended=()=>{b.innerText='‚ñ∂';b.classList.remove('playing');bar.style.width='0%';currentAudio=null;}; s.play(); }
        $('rec-btn').onclick=async()=>{const b=$('rec-btn');if(b.classList.contains('rec-pulse')){mediaRecorder.stop();b.classList.remove('rec-pulse');}else{try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(s);audioChunks=[];mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);mediaRecorder.onstop=()=>{const bl=new Blob(audioChunks,{type:'audio/webm'});const r=new FileReader();r.onload=()=>{const d=r.result.split(',')[1];const p={type:'audio',data:d,replyTo:replyTo,...(context==='pm'?{recipient:target}:{room_name:target})};ws.send(JSON.stringify(p));};r.readAsDataURL(bl);};mediaRecorder.start();b.classList.add('rec-pulse');}catch(e){alert("–ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞");}}};
        function openCtx(e,i,t,s) { 
            e.preventDefault(); ctxMsgId=i; ctxText=t; ctxSender=s; 
            const m=$('ctx-menu'); 
            m.style.left=Math.min(e.pageX,window.innerWidth-170)+'px'; m.style.top=Math.min(e.pageY,window.innerHeight-200)+'px'; m.style.display='block'; 
            const isAdmin = context==='room' && roomMeta && roomMeta.creator===myNick;
            $('ctx-kick').style.display = isAdmin ? 'block' : 'none';
            $('ctx-ban').style.display = isAdmin ? 'block' : 'none';
        }
        document.addEventListener('click',e=>{if(!e.target.closest('#ctx-menu'))$('ctx-menu').style.display='none';});
        function react(e) { ws.send(JSON.stringify({type:'reaction',message_id:ctxMsgId,emoji:e})); $('ctx-menu').style.display='none'; }
        function sendReact(i,e) { ws.send(JSON.stringify({type:'reaction',message_id:i,emoji:e})); }
        function updateReactions(i,r) { const c=$(`reacts-${i}`); if(!c)return; c.innerHTML=''; for(let [e,s] of Object.entries(r)) c.innerHTML+=`<div class="react-pill ${s.includes(myNick)?'active':''}" onclick="sendReact(${i},'${e}')">${e} ${s.length}</div>`; }
        function doReply() { replyTo={text:ctxText,sender:ctxSender}; editingId=null; $('reply-preview').style.display='flex'; $('rp-text').innerText=`–û—Ç–≤–µ—Ç: ${ctxSender}`; $('ctx-menu').style.display='none'; $('msg-in').focus(); }
        function startEdit() { if(ctxSender!==myNick)return alert("–ù–µ–ª—å–∑—è!"); editingId=ctxMsgId; replyTo=null; $('reply-preview').style.display='flex'; $('rp-text').innerText="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."; $('msg-in').value=ctxText; $('msg-in').focus(); $('ctx-menu').style.display='none'; }
        function deleteMsg() { if(ctxSender!==myNick && !(context==='room'&&roomMeta.creator===myNick))return alert("–ù–µ–ª—å–∑—è!"); if(confirm("–£–¥–∞–ª–∏—Ç—å?")) ws.send(JSON.stringify({type:'delete_msg',id:ctxMsgId,...(context==='pm'?{recipient:target}:{room_name:target})})); $('ctx-menu').style.display='none'; }
        function pinMsg() { if(!(context==='room'&&roomMeta.creator===myNick))return alert("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –∫—Ä–µ–ø–∏—Ç—å"); ws.send(JSON.stringify({type:'pin_msg', id:ctxMsgId, room_name:target})); $('ctx-menu').style.display='none'; }
        function kickUser() { if(confirm(`–ö–∏–∫–Ω—É—Ç—å ${ctxSender}?`)) ws.send(JSON.stringify({type:'kick_user', user:ctxSender, room_name:target})); $('ctx-menu').style.display='none'; }
        function banUser() { if(confirm(`–ó–∞–±–∞–Ω–∏—Ç—å ${ctxSender}?`)) ws.send(JSON.stringify({type:'ban_user', user:ctxSender, room_name:target})); $('ctx-menu').style.display='none'; }
        function showPinned(msg) { if(!msg) return; pinnedMsgId = msg.id; $('pinned-bar').style.display = 'block'; $('pinned-text').innerText = (msg.text || "[–ú–µ–¥–∏–∞]").substring(0, 50); }
        function scrollToPinned() { const el = $(`msg-${pinnedMsgId}`); if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'}); }
        function toggleSearch() { const b=$('search-box'); b.style.display=b.style.display==='none'?'block':'none'; if(b.style.display==='block')$('search-input').focus(); }
        function doSearch(t) { t=t.toLowerCase(); document.querySelectorAll('.msg').forEach(m=>{ m.style.display = m.innerText.toLowerCase().includes(t) ? 'flex' : 'none'; }); }
        function doCopy() { navigator.clipboard.writeText(ctxText); $('ctx-menu').style.display='none'; }
        function cancelReply() { replyTo=null; editingId=null; $('msg-in').value=''; $('reply-preview').style.display='none'; }
        function createRoom() { const n=$('new-room-name').value.trim(), t=$('new-room-type').value; if(n) ws.send(JSON.stringify({type:'create_room',name:n,rtype:t})); $('room-modal').close(); }
        function viewImg(s) { $('lb-img').src=s; zoomLevel=1; $('lb-img').style.transform='scale(1)'; $('lightbox').style.display='flex'; }
        function zoomImage(e) { e.preventDefault(); zoomLevel+=e.deltaY*-0.001; zoomLevel=Math.min(Math.max(.5,zoomLevel),4); $('lb-img').style.transform=`scale(${zoomLevel})`; }
        function scrollToBottom() { const d=$('messages'); d.scrollTop=d.scrollHeight; }
        const bindEnter = (id, fn) => $(id).addEventListener('keydown', e => { if(e.key === 'Enter') fn(); });
        bindEnter('msg-in', send); bindEnter('l-pass', ()=>auth('login')); bindEnter('r-pass', ()=>auth('register'));
    </script>
</body>
</html>
